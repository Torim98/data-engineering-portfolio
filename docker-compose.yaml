version: '3.8'

services:
  ingestion:
    build: ./ingestion
    container_name: chess-ingestion
    volumes:
      - ./data:/data
      - ./logs:/logs
    environment:
      - SOURCE_DIR=/data
      - FILE_PATTERN=.pgn.zst
      # Test-Limit (0 f√ºr "Alles verarbeiten")
      - MAX_GAMES=0
      - CHUNK_SIZE=10000      # Partitioning: Speichere alle 10k Partien eine Datei
      - TARGET_DIR=/data/raw

  processing:
    build: ./processing
    container_name: chess-processing
    volumes:
      - ./data:/data
      - ./logs:/logs
    depends_on:
      ingestion:
        # WICHTIG: Wartet, bis Ingestion erfolgreich beendet ist!
        condition: service_completed_successfully
    environment:
      - SOURCE_FILE=/data/raw/games.parquet
      - TARGET_FILE=/data/processed/stats.parquet

  dashboard:
    build: ./dashboard
    container_name: chess-dashboard
    volumes:
      - ./data:/data
      - ./logs:/logs
    ports:
      - "8501:8501"
    depends_on:
      processing:
        # Dashboard wartet, bis Processing fertig ist
        condition: service_completed_successfully